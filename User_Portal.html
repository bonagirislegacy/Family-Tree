<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonagiri's Legacy - User Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Playfair Display', 'serif'] },
                    colors: { dark: { bg: '#000000', card: '#121212', accent: '#6366F1' } }
                }
            }
        }
    </script>
</head>
<body class="bg-black text-gray-200 h-screen overflow-hidden flex flex-col font-sans">

    <!-- Navbar -->
    <nav class="border-b border-gray-800 bg-[#050505] px-6 py-4 flex justify-between items-center z-50">
        <h1 class="text-xl font-serif font-bold text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-indigo-500">diversity_2</span>
            Bonagiri's Portal
        </h1>
        
        <div class="flex items-center gap-4">
            <button onclick="window.open('Bonagiris_Legacy.html', '_blank')" class="text-sm text-gray-400 hover:text-white transition flex items-center gap-1 cursor-pointer mr-2">
                <span class="material-symbols-outlined text-[18px]">account_tree</span> View Tree <span class="material-symbols-outlined text-[12px]">open_in_new</span>
            </button>

            <div id="nav-actions" class="hidden flex items-center gap-4 border-l border-gray-800 pl-4">
                <button onclick="switchTab('profile')" id="nav-profile-btn" class="text-white font-medium border-b-2 border-indigo-500 px-2 py-1 transition">Profile</button>
                <button onclick="switchTab('events')" id="nav-events-btn" class="text-gray-400 hover:text-white px-2 py-1 transition">Events</button>
                
                <button onclick="toggleProfile()" class="flex items-center gap-2 hover:bg-gray-800 px-3 py-1.5 rounded-full transition border border-gray-700 ml-2">
                    <div class="w-6 h-6 rounded-full bg-indigo-600 flex items-center justify-center text-xs font-bold overflow-hidden">
                        <img id="nav-user-img" src="" class="w-full h-full object-cover hidden">
                        <span id="nav-user-initial">U</span>
                    </div>
                    <span class="text-sm font-medium" id="user-name-display">User</span>
                </button>
                <button onclick="logout()" class="text-red-400 hover:text-red-300 text-sm ml-2">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="flex-1 relative flex justify-center items-center p-4">
        
        <!-- Login Form -->
        <div id="login-container" class="w-full max-w-md bg-[#121212] border border-gray-800 p-8 rounded-xl shadow-2xl relative z-10">
            <h2 class="text-2xl font-serif text-white mb-6 text-center">Family Login</h2>
            <div class="space-y-4">
                <input type="text" id="login-id" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-3 text-white focus:border-indigo-500 outline-none" placeholder="User ID">
                <input type="password" id="login-pass" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-3 text-white focus:border-indigo-500 outline-none" placeholder="Password">
                <button onclick="handleLogin()" id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded transition flex justify-center items-center">
                    <span>Login</span>
                </button>
                <p id="login-msg" class="text-center text-sm text-red-400 mt-2 h-5"></p>
            </div>
        </div>

        <!-- APP CONTAINER -->
        <div id="app-container" class="hidden w-full max-w-4xl bg-[#121212] border border-gray-800 rounded-xl shadow-2xl flex flex-col h-[85vh] overflow-hidden">
            
            <!-- PROFILE TAB -->
            <div id="tab-profile" class="h-full flex flex-col">
                <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-[#1A1A1A]">
                    <div>
                        <h2 class="text-xl font-serif text-white">My Profile</h2>
                        <p class="text-xs text-gray-500 mt-1">Manage your personal details.</p>
                    </div>
                    <div id="view-actions">
                        <button onclick="toggleEditMode(true)" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white text-sm font-medium rounded flex items-center gap-2 border border-gray-600 transition">
                            <span class="material-symbols-outlined text-[18px]">edit</span> Edit Details
                        </button>
                    </div>
                    <div id="edit-actions" class="hidden flex gap-2">
                        <button onclick="toggleEditMode(false)" class="px-4 py-2 bg-transparent hover:bg-gray-800 text-gray-300 text-sm font-medium rounded border border-gray-600 transition">Cancel</button>
                        <button onclick="saveChanges()" id="save-btn" class="px-4 py-2 bg-indigo-700 hover:bg-indigo-600 text-white text-sm font-medium rounded flex items-center gap-2 shadow-lg transition">Submit Request</button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                    <!-- View Mode -->
                    <div id="view-mode" class="space-y-8 animate-fade-in">
                        <div class="flex flex-col md:flex-row gap-8 items-center md:items-start pb-6 border-b border-gray-800">
                            <img id="view-photo" src="" class="w-32 h-32 rounded-full object-cover border-4 border-gray-800 bg-gray-900 shadow-xl">
                            <div class="text-center md:text-left space-y-2 pt-2">
                                <h3 id="view-name" class="text-3xl font-serif text-white">Loading...</h3>
                                <div class="inline-block bg-gray-900 border border-gray-800 rounded px-2 py-1 text-xs text-gray-400 font-mono">
                                    Family ID: <span id="view-id" class="text-indigo-400 font-bold">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-6">
                                <div><h4 class="text-xs text-indigo-400 font-bold uppercase tracking-widest mb-2">Dates</h4><div class="flex gap-4 text-gray-300"><div class="bg-gray-900/50 p-3 rounded border border-gray-800 flex-1"><span class="text-[10px] text-gray-500 block mb-1">BORN</span><span id="view-dob" class="font-medium">-</span></div><div class="bg-gray-900/50 p-3 rounded border border-gray-800 flex-1"><span class="text-[10px] text-gray-500 block mb-1">DIED</span><span id="view-dod" class="font-medium text-gray-400">-</span></div></div></div>
                            </div>
                            <div class="space-y-6">
                                <div><h4 class="text-xs text-indigo-400 font-bold uppercase tracking-widest mb-2">Status</h4><div class="space-y-3"><div class="flex justify-between border-b border-gray-800 pb-2"><span class="text-gray-500 text-sm">Location</span><span id="view-location" class="text-gray-200">-</span></div><div class="flex justify-between border-b border-gray-800 pb-2"><span class="text-gray-500 text-sm">Occupation</span><span id="view-occupation" class="text-gray-200">-</span></div></div></div>
                            </div>
                        </div>
                        <div><h4 class="text-xs text-indigo-400 font-bold uppercase tracking-widest mb-2">Biography</h4><div class="bg-gray-900/30 p-4 rounded-lg border border-gray-800"><p id="view-bio" class="text-gray-300 leading-relaxed font-light text-lg">No biography loaded.</p></div></div>
                    </div>
                    <!-- Edit Mode -->
                    <div id="edit-mode" class="hidden space-y-6">
                         <div class="flex flex-col items-center gap-4 mb-6 pb-6 border-b border-gray-800">
                            <img id="edit-photo-preview" src="" class="w-24 h-24 rounded-full object-cover border-2 border-indigo-500">
                            <input type="file" id="edit-photo-input" accept="image/*" class="hidden" onchange="handlePhotoSelect(this)">
                            <button onclick="document.getElementById('edit-photo-input').click()" class="text-xs bg-gray-800 px-3 py-1 rounded text-gray-300 border border-gray-700">Change Photo</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-gray-500 uppercase">Name</label><input type="text" id="edit-name" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-2 text-white"></div><div><label class="text-xs text-gray-500 uppercase">ID</label><div id="edit-id" class="w-full bg-gray-900 p-2 rounded text-gray-500"></div></div></div>
                        <div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-gray-500 uppercase">DOB</label><input type="date" id="edit-dob" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-2 text-white [color-scheme:dark]"></div><div><label class="text-xs text-gray-500 uppercase">DOD</label><input type="date" id="edit-dod" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-2 text-white [color-scheme:dark]"></div></div>
                        <div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-gray-500 uppercase">Location</label><input type="text" id="edit-location" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-2 text-white"></div><div><label class="text-xs text-gray-500 uppercase">Occupation</label><input type="text" id="edit-occupation" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-2 text-white"></div></div>
                        <div><label class="text-xs text-gray-500 uppercase">Bio</label><textarea id="edit-bio" class="w-full h-32 bg-[#0A0A0A] border border-gray-700 rounded p-2 text-white"></textarea></div>
                    </div>
                </div>
            </div>

            <!-- EVENTS TAB -->
            <div id="tab-events" class="hidden h-full flex flex-col bg-[#121212]">
                <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-[#1A1A1A]">
                    <div>
                        <h2 class="text-xl font-serif text-white">Family Events</h2>
                        <p class="text-xs text-gray-500 mt-1">Gatherings & Celebrations.</p>
                    </div>
                    <button onclick="openCreateEventModal()" class="px-4 py-2 bg-indigo-700 hover:bg-indigo-600 text-white text-sm font-medium rounded flex items-center gap-2 shadow-lg transition">
                        <span class="material-symbols-outlined text-[18px]">add</span> Create Event
                    </button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6">
                    <div class="mb-8">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 border-b border-gray-800 pb-2">My Invitations</h3>
                        <div id="invites-list" class="space-y-3">
                            <div class="text-sm text-gray-600 italic">Loading invites...</div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 border-b border-gray-800 pb-2">Events I'm Hosting</h3>
                        <div id="hosting-list" class="space-y-3">
                            <div class="text-sm text-gray-600 italic">Loading events...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div id="event-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-[#1A1A1A] border border-gray-700 rounded-xl p-6 max-w-lg w-full shadow-2xl">
            <h3 class="text-xl font-serif text-white mb-4">Create New Event</h3>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <input type="text" id="evt-title" placeholder="Event Title (e.g., Birthday Bash)" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-3 text-white">
                <textarea id="evt-desc" placeholder="Details..." class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-3 text-white h-20"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input type="date" id="evt-date" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-3 text-white [color-scheme:dark]">
                    <input type="time" id="evt-time" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-3 text-white [color-scheme:dark]">
                </div>
                <input type="text" id="evt-loc" placeholder="Location" class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-3 text-white">
                
                <!-- Invite Search -->
                <div>
                    <label class="text-xs text-gray-500 uppercase mb-1 block">Invite Family</label>
                    <input type="text" id="invite-search" placeholder="Type name to search database..." class="w-full bg-[#0A0A0A] border border-gray-700 rounded p-2 text-white text-sm">
                    <div id="invite-dropdown" class="bg-gray-800 border border-gray-700 rounded mt-1 max-h-32 overflow-y-auto hidden"></div>
                    <div id="selected-guests" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('event-modal').classList.add('hidden')" class="flex-1 bg-gray-800 text-gray-300 py-2 rounded">Cancel</button>
                <button onclick="submitEvent()" id="btn-create-evt" class="flex-1 bg-indigo-700 text-white py-2 rounded">Create Event</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="info-modal" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-[#1A1A1A] border border-gray-700 rounded-xl p-6 max-w-sm w-full shadow-2xl text-center">
            <h3 class="text-xl font-serif text-white mb-2" id="modal-title">Success</h3>
            <p class="text-sm text-gray-400 mb-6" id="modal-msg">Operation completed.</p>
            <button onclick="document.getElementById('info-modal').classList.add('hidden')" class="w-full bg-gray-800 text-white py-2 rounded border border-gray-600">Okay</button>
        </div>
    </div>

    <script>
        // ======================================================
        // PASTE YOUR NEW GOOGLE APPS SCRIPT WEB APP URL HERE
        // ======================================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxvg_WIWee5_bz2Ox_XcRuRyGJ_ntnX7WFe9AckY7UImy75w6VvPEzr_PEEIGCtC3Mf7Q/exec"; 
        // ======================================================

        let currentUser = null;
        let newPhotoBase64 = null; 
        let familyDirectory = [];
        let selectedGuestIds = [];

        async function callScript(data) {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(data),
                redirect: "follow"
            });
            const text = await response.text();
            try { return JSON.parse(text); } 
            catch (e) { console.error("SERVER ERROR:", text); throw new Error("Server Response Error"); }
        }

        // --- AUTH ---
        function handleLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const btn = document.getElementById('login-btn');
            const msg = document.getElementById('login-msg');

            if(!id || !pass) { msg.textContent = "Enter ID & Password"; return; }
            btn.innerHTML = `Verifying...`; btn.disabled = true; msg.textContent = "";

            callScript({ action: "login", id: id, password: pass })
            .then(data => {
                btn.innerHTML = "Login"; btn.disabled = false;
                if(data.success) {
                    if (!data.user) {
                        alert("Login valid but profile data missing. Check database.");
                        return;
                    }
                    currentUser = data.user;
                    initApp();
                } else { msg.textContent = data.message || "Login Failed"; }
            }).catch(e => { btn.innerHTML = "Login"; btn.disabled = false; msg.textContent = "Connection Error"; });
        }

        function initApp() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('nav-actions').classList.remove('hidden');
            document.getElementById('nav-actions').classList.add('flex');
            
            const safeName = currentUser.name ? currentUser.name : ("User " + currentUser.id);
            document.getElementById('user-name-display').textContent = safeName;
            
            // View Mode
            let photoUrl = currentUser.photo;
            if (!photoUrl || photoUrl.length < 5) photoUrl = 'https://ui-avatars.com/api/?background=333&color=fff&name=' + encodeURIComponent(safeName);
            
            document.getElementById('view-photo').src = photoUrl;
            document.getElementById('view-name').textContent = safeName;
            document.getElementById('view-id').textContent = currentUser.id || "N/A";
            document.getElementById('view-dob').textContent = currentUser.dob || "-";
            document.getElementById('view-dod').textContent = currentUser.dod || "-";
            document.getElementById('view-location').textContent = currentUser.location || "-";
            document.getElementById('view-occupation').textContent = currentUser.occupation || "-";
            document.getElementById('view-bio').textContent = currentUser.bio || "No biography available.";

            // Edit Mode
            document.getElementById('edit-id').textContent = currentUser.id;
            document.getElementById('edit-name').value = safeName;
            document.getElementById('edit-location').value = currentUser.location || "";
            document.getElementById('edit-occupation').value = currentUser.occupation || "";
            document.getElementById('edit-bio').value = currentUser.bio || "";
            document.getElementById('edit-dob').value = currentUser.dob || "";
            document.getElementById('edit-dod').value = currentUser.dod || "";

            loadDirectory();
            loadEvents();
        }

        function switchTab(tab) {
            document.getElementById('tab-profile').classList.add('hidden');
            document.getElementById('tab-events').classList.add('hidden');
            document.getElementById('nav-profile-btn').className = "text-gray-400 hover:text-white px-2 py-1 transition";
            document.getElementById('nav-events-btn').className = "text-gray-400 hover:text-white px-2 py-1 transition";

            if (tab === 'profile') {
                document.getElementById('tab-profile').classList.remove('hidden');
                document.getElementById('nav-profile-btn').className = "text-white font-medium border-b-2 border-indigo-500 px-2 py-1 transition";
            } else {
                document.getElementById('tab-events').classList.remove('hidden');
                document.getElementById('nav-events-btn').className = "text-white font-medium border-b-2 border-indigo-500 px-2 py-1 transition";
                loadEvents();
            }
        }

        // --- PROFILE LOGIC ---
        function toggleEditMode(isEdit) {
            if(isEdit) {
                document.getElementById('view-mode').classList.add('hidden');
                document.getElementById('edit-mode').classList.remove('hidden');
                document.getElementById('view-actions').classList.add('hidden');
                document.getElementById('edit-actions').classList.remove('hidden');
            } else {
                document.getElementById('edit-mode').classList.add('hidden');
                document.getElementById('view-mode').classList.remove('hidden');
                document.getElementById('edit-actions').classList.add('hidden');
                document.getElementById('view-actions').classList.remove('hidden');
            }
        }

        function handlePhotoSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-photo-preview').src = e.target.result;
                    newPhotoBase64 = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveChanges() {
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `Sending...`; btn.disabled = true;

            const updateData = {
                action: "update",
                id: currentUser.id,
                name: document.getElementById('edit-name').value,
                location: document.getElementById('edit-location').value,
                occupation: document.getElementById('edit-occupation').value,
                bio: document.getElementById('edit-bio').value,
                dob: document.getElementById('edit-dob').value,
                dod: document.getElementById('edit-dod').value
            };
            if (newPhotoBase64) updateData.photoData = newPhotoBase64; 

            callScript(updateData).then(data => {
                btn.innerHTML = originalText; btn.disabled = false;
                if(data.success) showInfoModal("Success", "Request submitted to Admin.");
                else showInfoModal("Error", data.message);
            });
        }

        // --- EVENTS LOGIC ---
        function loadDirectory() {
            callScript({ action: "get_family_directory" }).then(res => {
                if(res.success) familyDirectory = res.directory;
                else console.error("Directory Load Failed:", res.message);
            });
        }

        function loadEvents() {
            document.getElementById('invites-list').innerHTML = `<div class="text-sm text-gray-500">Loading...</div>`;
            document.getElementById('hosting-list').innerHTML = `<div class="text-sm text-gray-500">Loading...</div>`;
            
            callScript({ action: "get_events", userId: currentUser.id }).then(res => {
                if(!res.success) return;
                renderEventList('invites-list', res.invited, true);
                renderEventList('hosting-list', res.hosting, false);
            });
        }

        function renderEventList(elementId, events, isInvited) {
            const el = document.getElementById(elementId);
            el.innerHTML = "";
            if (events.length === 0) {
                el.innerHTML = `<div class="text-sm text-gray-700 italic">No events found.</div>`;
                return;
            }
            events.forEach(ev => {
                let actionHtml = '';
                if (isInvited) {
                    if (ev.myStatus === 'pending') {
                        actionHtml = `
                            <div class="flex gap-2 mt-2">
                                <button onclick="rsvp('${ev.eventId}', 'accepted')" class="text-xs bg-green-900 text-green-200 px-2 py-1 rounded hover:bg-green-800">Accept</button>
                                <button onclick="rsvp('${ev.eventId}', 'declined')" class="text-xs bg-red-900 text-red-200 px-2 py-1 rounded hover:bg-red-800">Decline</button>
                            </div>`;
                    } else {
                        const statusColor = ev.myStatus === 'accepted' ? 'text-green-400' : 'text-red-400';
                        actionHtml = `<div class="text-xs ${statusColor} mt-2 uppercase font-bold">${ev.myStatus}</div>`;
                    }
                } else {
                    actionHtml = `<div class="text-xs text-indigo-400 mt-2">${ev.guestCount} Guests Invited</div>`;
                }

                const item = document.createElement('div');
                item.className = "bg-[#0A0A0A] border border-gray-800 p-4 rounded-lg";
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-white text-sm">${ev.title}</h4>
                            <div class="text-[10px] text-indigo-400 font-medium mt-0.5">Hosted by ${ev.creatorId === currentUser.id ? "You" : ev.creatorName}</div>
                        </div>
                        <span class="text-[10px] bg-gray-800 text-gray-400 px-1.5 rounded">${ev.date}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 mb-2">${ev.desc}</p>
                    <div class="flex items-center gap-2 mt-2 text-xs text-gray-400">
                        <span class="material-symbols-outlined text-[14px]">schedule</span> ${ev.time}
                        <span class="material-symbols-outlined text-[14px] ml-2">location_on</span> ${ev.location}
                    </div>
                    ${actionHtml}
                `;
                el.appendChild(item);
            });
        }

        function openCreateEventModal() {
            document.getElementById('event-modal').classList.remove('hidden');
            selectedGuestIds = [];
            renderSelectedGuests();
            
            // Invite Search Logic
            const searchInp = document.getElementById('invite-search');
            const drop = document.getElementById('invite-dropdown');
            
            searchInp.oninput = (e) => {
                const q = e.target.value.toLowerCase();
                drop.innerHTML = "";
                if (q.length < 2) { drop.classList.add('hidden'); return; }
                
                const matches = familyDirectory.filter(u => u.name.toLowerCase().includes(q) && u.id !== currentUser.id && !selectedGuestIds.includes(u.id));
                if (matches.length > 0) {
                    drop.classList.remove('hidden');
                    matches.forEach(m => {
                        const d = document.createElement('div');
                        d.className = "p-2 hover:bg-gray-700 cursor-pointer text-xs text-gray-300 border-b border-gray-700 last:border-0";
                        d.textContent = m.name;
                        d.onclick = () => {
                            selectedGuestIds.push(m.id);
                            renderSelectedGuests();
                            searchInp.value = "";
                            drop.classList.add('hidden');
                        };
                        drop.appendChild(d);
                    });
                } else { drop.classList.add('hidden'); }
            };
        }

        function renderSelectedGuests() {
            const container = document.getElementById('selected-guests');
            container.innerHTML = "";
            selectedGuestIds.forEach(id => {
                const user = familyDirectory.find(u => u.id === id);
                if (!user) return;
                const tag = document.createElement('span');
                tag.className = "text-[10px] bg-indigo-900 text-indigo-200 px-2 py-1 rounded flex items-center gap-1";
                tag.innerHTML = `${user.name} <button onclick="removeGuest('${id}')" class="hover:text-white font-bold ml-1">Ã—</button>`;
                container.appendChild(tag);
            });
        }
        
        window.removeGuest = function(id) {
            selectedGuestIds = selectedGuestIds.filter(g => g !== id);
            renderSelectedGuests();
        };

        function submitEvent() {
            const btn = document.getElementById('btn-create-evt');
            btn.innerHTML = "Creating..."; btn.disabled = true;
            
            const evtData = {
                action: "create_event",
                creatorId: currentUser.id,
                title: document.getElementById('evt-title').value,
                description: document.getElementById('evt-desc').value,
                date: document.getElementById('evt-date').value,
                time: document.getElementById('evt-time').value,
                location: document.getElementById('evt-loc').value,
                guests: selectedGuestIds
            };

            callScript(evtData).then(res => {
                btn.innerHTML = "Create Event"; btn.disabled = false;
                document.getElementById('event-modal').classList.add('hidden');
                if (res.success) {
                    showInfoModal("Success", "Event Created!");
                    loadEvents();
                } else {
                    showInfoModal("Error", "Failed: " + res.message);
                }
            });
        }

        function rsvp(eventId, status) {
            callScript({ action: "rsvp_event", userId: currentUser.id, eventId: eventId, status: status })
            .then(res => {
                if(res.success) loadEvents();
            });
        }

        function showInfoModal(title, msg) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-msg').textContent = msg;
            document.getElementById('info-modal').classList.remove('hidden');
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-id').value = "";
            document.getElementById('login-pass').value = "";
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('nav-actions').classList.remove('flex');
            document.getElementById('nav-actions').classList.add('hidden');
            document.getElementById('login-container').classList.remove('hidden');
        }
        
        function toggleProfile() { switchTab('profile'); }
    </script>
</body>
</html>